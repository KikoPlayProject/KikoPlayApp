这个扩展主要由LLM开发（Trae, Kimi-k2），下面的内容也是它生成的
# 音乐播放器扩展

这是一个为KikoPlay开发的音乐播放器扩展App，基于libmpv播放器组件实现。

## 功能特性

- ✅ **播放控制**: 播放、暂停、上一首、下一首、进度条控制、音量控制、静音切换
- ✅ **循环模式**: 支持列表顺序、列表循环、列表随机、单曲循环四种模式
- ✅ **音乐信息显示**: 显示标题、艺术家、专辑、时长（通过 mpv 获取准确元数据）
- ✅ **歌词显示**: 支持 LRC 格式歌词文件解析和显示，自动查找同目录下的 `.lrc` 文件，支持内嵌歌词获取
- ✅ **播放列表管理**: 支持添加音频文件、多列显示、双击播放、清空列表、右键菜单（删除、上移、下移）
- ✅ **播放列表自动保存和启动时加载**
- ✅ **基于 libmpv 的播放器组件**: 实现音频播放（默认隐藏）
- ✅ **美观界面**: 现代化的UI设计，支持深色和浅色主题
- ✅ **设置持久化**: 音量和循环模式设置自动保存和恢复

## 支持的音频格式

支持所有libmpv支持的音频格式，包括：
- MP3
- WAV  
- FLAC
- AAC
- OGG
- M4A
- 以及其他常见音频格式

## 使用方法

1. **添加音乐文件**: 点击"添加文件"按钮选择音频文件，支持多选
2. **播放控制**: 
   - 点击"播放"按钮开始播放
   - 使用"上一首"/"下一首"按钮切换歌曲
   - 拖拽进度条调整播放位置
3. **循环模式**: 
   - 在播放控制区域选择循环模式：列表顺序、列表循环、列表随机、单曲循环
   - 列表顺序：播放到最后一首后停止
   - 列表循环：播放到最后一首后回到第一首继续播放
   - 列表随机：随机播放列表中的歌曲
   - 单曲循环：重复播放当前歌曲
4. **音量控制**: 
   - 拖拽音量滑块调整音量
   - 点击"静音"按钮切换静音状态
5. **播放列表**: 
   - 双击列表中的歌曲直接播放
   - 右键点击歌曲显示菜单：删除、上移、下移
   - 点击"清空列表"按钮清空所有歌曲

## 界面布局

- **左侧**: 播放列表，显示歌曲信息（标题、艺术家、专辑、时长）
- **右上**: 当前播放歌曲的详细信息
- **右中**: 播放器可视化区域
- **右下**: 播放控制按钮、进度条、音量控制

## 技术实现

- **播放器组件**: 基于 libmpv 的 player 组件（默认隐藏）
- **循环模式**: 四种模式支持（列表顺序、列表循环、列表随机、单曲循环）
- **UI组件**: 使用 combo 下拉框组件，通过 Lua 代码动态添加项目
- **元数据获取**: 通过 mpv 的 property 接口获取准确的音频元信息
- **播放列表**: JSON 格式保存，支持自动保存和启动时加载
- **设置持久化**: 音量和循环模式设置通过 kiko.storage 保存和恢复
- **界面布局**: 左侧播放列表 + 右侧播放控制区域
- **样式设计**: QSS 样式表，支持现代化 UI设计
- **右键菜单**: 播放列表支持右键菜单操作（删除、上移、下移）
- **调试日志**: 添加详细日志跟踪循环模式切换和播放状态变化
- **随机数生成**: 使用math.randomseed(os.time())初始化随机数生成器，确保真正的随机播放效果
- **单曲循环修复**: 使用loadfile重新加载当前歌曲，确保单曲循环模式正常工作
- **列表顺序修复**: 确保播放完最后一首后正确停止播放，不自动跳转播放第一首
- **歌词功能**: 支持LRC格式歌词解析，自动查找同目录.lrc文件，支持内嵌歌词获取（通过player:property获取metadata），在文件加载完成时获取歌词（onPlayerDurationChanged事件）

## 开发说明

本扩展遵循KikoPlay扩展开发规范：
- 使用`app.json`定义扩展基本信息
- 使用`app.xml`描述UI界面
- 使用`app.lua`实现业务逻辑
- 使用`style.qss`定义界面样式

### UI组件使用注意事项
- **combo下拉框组件**：不能通过XML嵌套item节点添加项目，需要通过Lua代码的`append`方法动态添加
- **循环模式实现**：使用combo组件展示四种播放模式，通过`current_changed`事件处理模式切换（注意：不是`current_index_changed`）

播放器组件基于libmpv，支持丰富的播放控制功能和事件监听。